<html>
<head>
<title>feature_engineering.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5c6370; font-style: italic;}
.s1 { color: #bbbbbb;}
.s2 { color: #d55fde; font-style: italic;}
.s3 { color: #89ca78;}
.s4 { color: #d19a66;}
.s5 { color: #2bbac5;}
</style>
</head>
<body bgcolor="#282c34">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
feature_engineering.py</font>
</center></td></tr></table>
<pre><span class="s0">#############################################</span>
<span class="s0"># FEATURE ENGINEERING &amp; DATA PRE-PROCESSING</span>
<span class="s0">#############################################</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">seaborn </span><span class="s2">as </span><span class="s1">sns</span>
<span class="s2">from </span><span class="s1">matplotlib </span><span class="s2">import </span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s0"># !pip install missingno</span>
<span class="s2">import </span><span class="s1">missingno </span><span class="s2">as </span><span class="s1">msno</span>
<span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s1">date</span>
<span class="s2">from </span><span class="s1">sklearn.metrics </span><span class="s2">import </span><span class="s1">accuracy_score</span>
<span class="s2">from </span><span class="s1">sklearn.model_selection </span><span class="s2">import </span><span class="s1">train_test_split</span>
<span class="s2">from </span><span class="s1">sklearn.neighbors </span><span class="s2">import </span><span class="s1">LocalOutlierFactor</span>
<span class="s2">from </span><span class="s1">sklearn.preprocessing </span><span class="s2">import </span><span class="s1">MinMaxScaler, LabelEncoder, StandardScaler, RobustScaler</span>

<span class="s1">pd.set_option(</span><span class="s3">'display.max_columns'</span><span class="s1">, </span><span class="s2">None</span><span class="s1">)</span>
<span class="s1">pd.set_option(</span><span class="s3">'display.max_rows'</span><span class="s1">, </span><span class="s2">None</span><span class="s1">)</span>
<span class="s1">pd.set_option(</span><span class="s3">'display.float_format'</span><span class="s1">, </span><span class="s2">lambda </span><span class="s1">x: </span><span class="s3">'%.3f' </span><span class="s1">% x)</span>
<span class="s1">pd.set_option(</span><span class="s3">'display.width'</span><span class="s1">, </span><span class="s4">500</span><span class="s1">)</span>

<span class="s2">def </span><span class="s1">load_application_train():</span>
    <span class="s1">data = pd.read_csv(</span><span class="s3">&quot;datasets/application_train.csv&quot;</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">data</span>

<span class="s1">df = load_application_train()</span>
<span class="s1">df.head()</span>


<span class="s2">def </span><span class="s1">load():</span>
    <span class="s1">data = pd.read_csv(</span><span class="s3">&quot;datasets/titanic.csv&quot;</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">data</span>


<span class="s1">df = load()</span>
<span class="s1">df.head()</span>



<span class="s0">#############################################</span>
<span class="s0"># 1. Outliers (Aykırı Değerler)</span>
<span class="s0">#############################################</span>

<span class="s0">#############################################</span>
<span class="s0"># Aykırı Değerleri Yakalama</span>
<span class="s0">#############################################</span>

<span class="s0">###################</span>
<span class="s0"># Grafik Teknikle Aykırı Değerler</span>
<span class="s0">###################</span>

<span class="s1">sns.boxplot(x=df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">])</span>
<span class="s1">plt.show()</span>

<span class="s0">###################</span>
<span class="s0"># Aykırı Değerler Nasıl Yakalanır?</span>
<span class="s0">###################</span>

<span class="s1">q1 = df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].quantile(</span><span class="s4">0.25</span><span class="s1">)</span>
<span class="s1">q3 = df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].quantile(</span><span class="s4">0.75</span><span class="s1">)</span>
<span class="s1">iqr = q3 - q1</span>
<span class="s1">up = q3 + </span><span class="s4">1.5 </span><span class="s1">* iqr</span>
<span class="s1">low = q1 - </span><span class="s4">1.5 </span><span class="s1">* iqr</span>

<span class="s1">df[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &gt; up)]</span>

<span class="s1">df[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &gt; up)].index</span>

<span class="s0">###################</span>
<span class="s0"># Aykırı Değer Var mı Yok mu?</span>
<span class="s0">###################</span>

<span class="s1">df[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &gt; up)].any(axis=</span><span class="s2">None</span><span class="s1">)</span>
<span class="s1">df[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] &lt; low)].any(axis=</span><span class="s2">None</span><span class="s1">)</span>

<span class="s0"># 1. Eşik değer belirledik.</span>
<span class="s0"># 2. Aykırılara eriştik.</span>
<span class="s0"># 3. Hızlıca aykırı değer var mı yok diye sorduk.</span>

<span class="s0">###################</span>
<span class="s0"># İşlemleri Fonksiyonlaştırmak</span>
<span class="s0">###################</span>


<span class="s2">def </span><span class="s1">outlier_thresholds(dataframe, col_name, q1=</span><span class="s4">0.25</span><span class="s1">, q3=</span><span class="s4">0.75</span><span class="s1">):</span>
    <span class="s1">quartile1 = dataframe[col_name].quantile(q1)</span>
    <span class="s1">quartile3 = dataframe[col_name].quantile(q3)</span>
    <span class="s1">interquantile_range = quartile3 - quartile1</span>
    <span class="s1">up_limit = quartile3 + </span><span class="s4">1.5 </span><span class="s1">* interquantile_range</span>
    <span class="s1">low_limit = quartile1 - </span><span class="s4">1.5 </span><span class="s1">* interquantile_range</span>
    <span class="s2">return </span><span class="s1">low_limit, up_limit</span>

<span class="s1">outlier_thresholds(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">outlier_thresholds(df, </span><span class="s3">&quot;Fare&quot;</span><span class="s1">)</span>

<span class="s1">low, up = outlier_thresholds(df, </span><span class="s3">&quot;Fare&quot;</span><span class="s1">)</span>

<span class="s1">df[(df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up)].head()</span>


<span class="s1">df[(df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up)].index</span>

<span class="s2">def </span><span class="s1">check_outlier(dataframe, col_name):</span>
    <span class="s1">low_limit, up_limit = outlier_thresholds(dataframe, col_name)</span>
    <span class="s2">if </span><span class="s1">dataframe[(dataframe[col_name] &gt; up_limit) | (dataframe[col_name] &lt; low_limit)].any(axis=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return True</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">return False</span>

<span class="s1">check_outlier(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">check_outlier(df, </span><span class="s3">&quot;Fare&quot;</span><span class="s1">)</span>

<span class="s0">###################</span>
<span class="s0"># grab_col_names</span>
<span class="s0">###################</span>

<span class="s1">dff = load_application_train()</span>
<span class="s1">dff.head()</span>

<span class="s2">def </span><span class="s1">grab_col_names(dataframe, cat_th=</span><span class="s4">10</span><span class="s1">, car_th=</span><span class="s4">20</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
 
    Veri setindeki kategorik, numerik ve kategorik fakat kardinal değişkenlerin isimlerini verir. 
    Not: Kategorik değişkenlerin içerisine numerik görünümlü kategorik değişkenler de dahildir. 
 
    Parameters 
    ------ 
        dataframe: dataframe 
                Değişken isimleri alınmak istenilen dataframe 
        cat_th: int, optional 
                numerik fakat kategorik olan değişkenler için sınıf eşik değeri 
        car_th: int, optinal 
                kategorik fakat kardinal değişkenler için sınıf eşik değeri 
 
    Returns 
    ------ 
        cat_cols: list 
                Kategorik değişken listesi 
        num_cols: list 
                Numerik değişken listesi 
        cat_but_car: list 
                Kategorik görünümlü kardinal değişken listesi 
 
    Examples 
    ------ 
        import seaborn as sns 
        df = sns.load_dataset(&quot;iris&quot;) 
        print(grab_col_names(df)) 
 
 
    Notes 
    ------ 
        cat_cols + num_cols + cat_but_car = toplam değişken sayısı 
        num_but_cat cat_cols'un içerisinde. 
        Return olan 3 liste toplamı toplam değişken sayısına eşittir: cat_cols + num_cols + cat_but_car = değişken sayısı 
 
    &quot;&quot;&quot;</span>

    <span class="s0"># cat_cols, cat_but_car</span>
    <span class="s1">cat_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">dataframe.columns </span><span class="s2">if </span><span class="s1">dataframe[col].dtypes == </span><span class="s3">&quot;O&quot;</span><span class="s1">]</span>
    <span class="s1">num_but_cat = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">dataframe.columns </span><span class="s2">if </span><span class="s1">dataframe[col].nunique() &lt; cat_th </span><span class="s2">and</span>
                   <span class="s1">dataframe[col].dtypes != </span><span class="s3">&quot;O&quot;</span><span class="s1">]</span>
    <span class="s1">cat_but_car = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">dataframe.columns </span><span class="s2">if </span><span class="s1">dataframe[col].nunique() &gt; car_th </span><span class="s2">and</span>
                   <span class="s1">dataframe[col].dtypes == </span><span class="s3">&quot;O&quot;</span><span class="s1">]</span>
    <span class="s1">cat_cols = cat_cols + num_but_cat</span>
    <span class="s1">cat_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cat_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s1">cat_but_car]</span>

    <span class="s0"># num_cols</span>
    <span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">dataframe.columns </span><span class="s2">if </span><span class="s1">dataframe[col].dtypes != </span><span class="s3">&quot;O&quot;</span><span class="s1">]</span>
    <span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s1">num_but_cat]</span>

    <span class="s1">print(</span><span class="s3">f&quot;Observations: </span><span class="s5">{</span><span class="s1">dataframe.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s5">}</span><span class="s3">&quot;</span><span class="s1">)</span>
    <span class="s1">print(</span><span class="s3">f&quot;Variables: </span><span class="s5">{</span><span class="s1">dataframe.shape[</span><span class="s4">1</span><span class="s1">]</span><span class="s5">}</span><span class="s3">&quot;</span><span class="s1">)</span>
    <span class="s1">print(</span><span class="s3">f'cat_cols: </span><span class="s5">{</span><span class="s1">len(cat_cols)</span><span class="s5">}</span><span class="s3">'</span><span class="s1">)</span>
    <span class="s1">print(</span><span class="s3">f'num_cols: </span><span class="s5">{</span><span class="s1">len(num_cols)</span><span class="s5">}</span><span class="s3">'</span><span class="s1">)</span>
    <span class="s1">print(</span><span class="s3">f'cat_but_car: </span><span class="s5">{</span><span class="s1">len(cat_but_car)</span><span class="s5">}</span><span class="s3">'</span><span class="s1">)</span>
    <span class="s1">print(</span><span class="s3">f'num_but_cat: </span><span class="s5">{</span><span class="s1">len(num_but_cat)</span><span class="s5">}</span><span class="s3">'</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">cat_cols, num_cols, cat_but_car</span>

<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s3">&quot;PassengerId&quot;</span><span class="s1">]</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>


<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(dff)</span>

<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s3">&quot;SK_ID_CURR&quot;</span><span class="s1">]</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(dff, col))</span>

<span class="s0">###################</span>
<span class="s0"># Aykırı Değerlerin Kendilerine Erişmek</span>
<span class="s0">###################</span>

<span class="s2">def </span><span class="s1">grab_outliers(dataframe, col_name, index=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s1">low, up = outlier_thresholds(dataframe, col_name)</span>

    <span class="s2">if </span><span class="s1">dataframe[((dataframe[col_name] &lt; low) | (dataframe[col_name] &gt; up))].shape[</span><span class="s4">0</span><span class="s1">] &gt; </span><span class="s4">10</span><span class="s1">:</span>
        <span class="s1">print(dataframe[((dataframe[col_name] &lt; low) | (dataframe[col_name] &gt; up))].head())</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">print(dataframe[((dataframe[col_name] &lt; low) | (dataframe[col_name] &gt; up))])</span>

    <span class="s2">if </span><span class="s1">index:</span>
        <span class="s1">outlier_index = dataframe[((dataframe[col_name] &lt; low) | (dataframe[col_name] &gt; up))].index</span>
        <span class="s2">return </span><span class="s1">outlier_index</span>

<span class="s1">grab_outliers(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>

<span class="s1">grab_outliers(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">, </span><span class="s2">True</span><span class="s1">)</span>

<span class="s1">age_index = grab_outliers(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">, </span><span class="s2">True</span><span class="s1">)</span>


<span class="s1">outlier_thresholds(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">check_outlier(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">grab_outliers(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">, </span><span class="s2">True</span><span class="s1">)</span>

<span class="s0">#############################################</span>
<span class="s0"># Aykırı Değer Problemini Çözme</span>
<span class="s0">#############################################</span>

<span class="s0">###################</span>
<span class="s0"># Silme</span>
<span class="s0">###################</span>

<span class="s1">low, up = outlier_thresholds(df, </span><span class="s3">&quot;Fare&quot;</span><span class="s1">)</span>
<span class="s1">df.shape</span>

<span class="s1">df[~((df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up))].shape</span>

<span class="s2">def </span><span class="s1">remove_outlier(dataframe, col_name):</span>
    <span class="s1">low_limit, up_limit = outlier_thresholds(dataframe, col_name)</span>
    <span class="s1">df_without_outliers = dataframe[~((dataframe[col_name] &lt; low_limit) | (dataframe[col_name] &gt; up_limit))]</span>
    <span class="s2">return </span><span class="s1">df_without_outliers</span>


<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s3">&quot;PassengerId&quot;</span><span class="s1">]</span>

<span class="s1">df.shape</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">new_df = remove_outlier(df, col)</span>

<span class="s1">df.shape[</span><span class="s4">0</span><span class="s1">] - new_df.shape[</span><span class="s4">0</span><span class="s1">]</span>

<span class="s0">###################</span>
<span class="s0"># Baskılama Yöntemi (re-assignment with thresholds)</span>
<span class="s0">###################</span>

<span class="s1">low, up = outlier_thresholds(df, </span><span class="s3">&quot;Fare&quot;</span><span class="s1">)</span>

<span class="s1">df[((df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up))][</span><span class="s3">&quot;Fare&quot;</span><span class="s1">]</span>

<span class="s1">df.loc[((df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up)), </span><span class="s3">&quot;Fare&quot;</span><span class="s1">]</span>

<span class="s1">df.loc[(df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &gt; up), </span><span class="s3">&quot;Fare&quot;</span><span class="s1">] = up</span>

<span class="s1">df.loc[(df[</span><span class="s3">&quot;Fare&quot;</span><span class="s1">] &lt; low), </span><span class="s3">&quot;Fare&quot;</span><span class="s1">] = low</span>

<span class="s2">def </span><span class="s1">replace_with_thresholds(dataframe, variable):</span>
    <span class="s1">low_limit, up_limit = outlier_thresholds(dataframe, variable)</span>
    <span class="s1">dataframe.loc[(dataframe[variable] &lt; low_limit), variable] = low_limit</span>
    <span class="s1">dataframe.loc[(dataframe[variable] &gt; up_limit), variable] = up_limit</span>

<span class="s1">df = load()</span>
<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>
<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s3">&quot;PassengerId&quot;</span><span class="s1">]</span>

<span class="s1">df.shape</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">replace_with_thresholds(df, col)</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>


<span class="s0">###################</span>
<span class="s0"># Recap</span>
<span class="s0">###################</span>

<span class="s1">df = load()</span>
<span class="s1">outlier_thresholds(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">check_outlier(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">grab_outliers(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">, index=</span><span class="s2">True</span><span class="s1">)</span>

<span class="s1">remove_outlier(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">).shape</span>
<span class="s1">replace_with_thresholds(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>
<span class="s1">check_outlier(df, </span><span class="s3">&quot;Age&quot;</span><span class="s1">)</span>




<span class="s0">#############################################</span>
<span class="s0"># Çok Değişkenli Aykırı Değer Analizi: Local Outlier Factor</span>
<span class="s0">#############################################</span>

<span class="s0"># 17, 3</span>

<span class="s1">df = sns.load_dataset(</span><span class="s3">'diamonds'</span><span class="s1">)</span>
<span class="s1">df = df.select_dtypes(include=[</span><span class="s3">'float64'</span><span class="s1">, </span><span class="s3">'int64'</span><span class="s1">])</span>
<span class="s1">df = df.dropna()</span>
<span class="s1">df.head()</span>
<span class="s1">df.shape</span>
<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>


<span class="s1">low, up = outlier_thresholds(df, </span><span class="s3">&quot;carat&quot;</span><span class="s1">)</span>

<span class="s1">df[((df[</span><span class="s3">&quot;carat&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;carat&quot;</span><span class="s1">] &gt; up))].shape</span>

<span class="s1">low, up = outlier_thresholds(df, </span><span class="s3">&quot;depth&quot;</span><span class="s1">)</span>

<span class="s1">df[((df[</span><span class="s3">&quot;depth&quot;</span><span class="s1">] &lt; low) | (df[</span><span class="s3">&quot;depth&quot;</span><span class="s1">] &gt; up))].shape</span>

<span class="s1">clf = LocalOutlierFactor(n_neighbors=</span><span class="s4">20</span><span class="s1">)</span>
<span class="s1">clf.fit_predict(df)</span>

<span class="s1">df_scores = clf.negative_outlier_factor_</span>
<span class="s1">df_scores[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span>
<span class="s0"># df_scores = -df_scores</span>
<span class="s1">np.sort(df_scores)[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span>

<span class="s1">scores = pd.DataFrame(np.sort(df_scores))</span>
<span class="s1">scores.plot(stacked=</span><span class="s2">True</span><span class="s1">, xlim=[</span><span class="s4">0</span><span class="s1">, </span><span class="s4">50</span><span class="s1">], style=</span><span class="s3">'.-'</span><span class="s1">)</span>
<span class="s1">plt.show()</span>

<span class="s1">th = np.sort(df_scores)[</span><span class="s4">3</span><span class="s1">]</span>

<span class="s1">df[df_scores &lt; th]</span>

<span class="s1">df[df_scores &lt; th].shape</span>


<span class="s1">df.describe([</span><span class="s4">0.01</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s4">0.75</span><span class="s1">, </span><span class="s4">0.90</span><span class="s1">, </span><span class="s4">0.99</span><span class="s1">]).T</span>

<span class="s1">df[df_scores &lt; th].index</span>

<span class="s1">df[df_scores &lt; th].drop(axis=</span><span class="s4">0</span><span class="s1">, labels=df[df_scores &lt; th].index)</span>


<span class="s0">#############################################</span>
<span class="s0"># Missing Values (Eksik Değerler)</span>
<span class="s0">#############################################</span>

<span class="s0">#############################################</span>
<span class="s0"># Eksik Değerlerin Yakalanması</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>
<span class="s1">df.head()</span>

<span class="s0"># eksik gozlem var mı yok mu sorgusu</span>
<span class="s1">df.isnull().values.any()</span>

<span class="s0"># degiskenlerdeki eksik deger sayisi</span>
<span class="s1">df.isnull().sum()</span>

<span class="s0"># degiskenlerdeki tam deger sayisi</span>
<span class="s1">df.notnull().sum()</span>

<span class="s0"># veri setindeki toplam eksik deger sayisi</span>
<span class="s1">df.isnull().sum().sum()</span>

<span class="s0"># en az bir tane eksik degere sahip olan gözlem birimleri</span>
<span class="s1">df[df.isnull().any(axis=</span><span class="s4">1</span><span class="s1">)]</span>

<span class="s0"># tam olan gözlem birimleri</span>
<span class="s1">df[df.notnull().all(axis=</span><span class="s4">1</span><span class="s1">)]</span>

<span class="s0"># Azalan şekilde sıralamak</span>
<span class="s1">df.isnull().sum().sort_values(ascending=</span><span class="s2">False</span><span class="s1">)</span>

<span class="s1">(df.isnull().sum() / df.shape[</span><span class="s4">0</span><span class="s1">] * </span><span class="s4">100</span><span class="s1">).sort_values(ascending=</span><span class="s2">False</span><span class="s1">)</span>

<span class="s1">na_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s1">df[col].isnull().sum() &gt; </span><span class="s4">0</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">missing_values_table(dataframe, na_name=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s1">na_columns = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">dataframe.columns </span><span class="s2">if </span><span class="s1">dataframe[col].isnull().sum() &gt; </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s1">n_miss = dataframe[na_columns].isnull().sum().sort_values(ascending=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">ratio = (dataframe[na_columns].isnull().sum() / dataframe.shape[</span><span class="s4">0</span><span class="s1">] * </span><span class="s4">100</span><span class="s1">).sort_values(ascending=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">missing_df = pd.concat([n_miss, np.round(ratio, </span><span class="s4">2</span><span class="s1">)], axis=</span><span class="s4">1</span><span class="s1">, keys=[</span><span class="s3">'n_miss'</span><span class="s1">, </span><span class="s3">'ratio'</span><span class="s1">])</span>
    <span class="s1">print(missing_df, end=</span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span><span class="s1">)</span>

    <span class="s2">if </span><span class="s1">na_name:</span>
        <span class="s2">return </span><span class="s1">na_columns</span>


<span class="s1">missing_values_table(df)</span>

<span class="s1">missing_values_table(df, </span><span class="s2">True</span><span class="s1">)</span>


<span class="s0">#############################################</span>
<span class="s0"># Eksik Değer Problemini Çözme</span>
<span class="s0">#############################################</span>

<span class="s1">missing_values_table(df)</span>

<span class="s0">###################</span>
<span class="s0"># Çözüm 1: Hızlıca silmek</span>
<span class="s0">###################</span>
<span class="s1">df.dropna().shape</span>

<span class="s0">###################</span>
<span class="s0"># Çözüm 2: Basit Atama Yöntemleri ile Doldurmak</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()).isnull().sum()</span>
<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].median()).isnull().sum()</span>
<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>

<span class="s0"># df.apply(lambda x: x.fillna(x.mean()), axis=0)</span>

<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mean()) </span><span class="s2">if </span><span class="s1">x.dtype != </span><span class="s3">&quot;O&quot; </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).head()</span>

<span class="s1">dff = df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mean()) </span><span class="s2">if </span><span class="s1">x.dtype != </span><span class="s3">&quot;O&quot; </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">)</span>

<span class="s1">dff.isnull().sum().sort_values(ascending=</span><span class="s2">False</span><span class="s1">)</span>

<span class="s1">df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].fillna(df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].mode()[</span><span class="s4">0</span><span class="s1">]).isnull().sum()</span>

<span class="s1">df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].fillna(</span><span class="s3">&quot;missing&quot;</span><span class="s1">)</span>

<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mode()[</span><span class="s4">0</span><span class="s1">]) </span><span class="s2">if </span><span class="s1">(x.dtype == </span><span class="s3">&quot;O&quot; </span><span class="s2">and </span><span class="s1">len(x.unique()) &lt;= </span><span class="s4">10</span><span class="s1">) </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>

<span class="s0">###################</span>
<span class="s0"># Kategorik Değişken Kırılımında Değer Atama</span>
<span class="s0">###################</span>


<span class="s1">df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()</span>

<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()</span>

<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].transform(</span><span class="s3">&quot;mean&quot;</span><span class="s1">)).isnull().sum()</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()[</span><span class="s3">&quot;female&quot;</span><span class="s1">]</span>

<span class="s1">df.loc[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].isnull()) &amp; (df[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">]==</span><span class="s3">&quot;female&quot;</span><span class="s1">), </span><span class="s3">&quot;Age&quot;</span><span class="s1">] = df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()[</span><span class="s3">&quot;female&quot;</span><span class="s1">]</span>

<span class="s1">df.loc[(df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].isnull()) &amp; (df[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">]==</span><span class="s3">&quot;male&quot;</span><span class="s1">), </span><span class="s3">&quot;Age&quot;</span><span class="s1">] = df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].mean()[</span><span class="s3">&quot;male&quot;</span><span class="s1">]</span>

<span class="s1">df.isnull().sum()</span>

<span class="s0">#############################################</span>
<span class="s0"># Çözüm 3: Tahmine Dayalı Atama ile Doldurma</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>

<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>
<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s1">col </span><span class="s2">not in </span><span class="s3">&quot;PassengerId&quot;</span><span class="s1">]</span>
<span class="s1">dff = pd.get_dummies(df[cat_cols + num_cols], drop_first=</span><span class="s2">True</span><span class="s1">)</span>

<span class="s1">dff.head()</span>

<span class="s0"># değişkenlerin standartlatırılması</span>
<span class="s1">scaler = MinMaxScaler()</span>
<span class="s1">dff = pd.DataFrame(scaler.fit_transform(dff), columns=dff.columns)</span>
<span class="s1">dff.head()</span>


<span class="s0"># knn'in uygulanması.</span>
<span class="s2">from </span><span class="s1">sklearn.impute </span><span class="s2">import </span><span class="s1">KNNImputer</span>
<span class="s1">imputer = KNNImputer(n_neighbors=</span><span class="s4">5</span><span class="s1">)</span>
<span class="s1">dff = pd.DataFrame(imputer.fit_transform(dff), columns=dff.columns)</span>
<span class="s1">dff.head()</span>

<span class="s1">dff = pd.DataFrame(scaler.inverse_transform(dff), columns=dff.columns)</span>

<span class="s1">df[</span><span class="s3">&quot;age_imputed_knn&quot;</span><span class="s1">] = dff[[</span><span class="s3">&quot;Age&quot;</span><span class="s1">]]</span>

<span class="s1">df.loc[df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].isnull(), [</span><span class="s3">&quot;Age&quot;</span><span class="s1">, </span><span class="s3">&quot;age_imputed_knn&quot;</span><span class="s1">]]</span>
<span class="s1">df.loc[df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].isnull()]</span>


<span class="s0">###################</span>
<span class="s0"># Recap</span>
<span class="s0">###################</span>

<span class="s1">df = load()</span>
<span class="s0"># missing table</span>
<span class="s1">missing_values_table(df)</span>
<span class="s0"># sayısal değişkenleri direk median ile oldurma</span>
<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.median()) </span><span class="s2">if </span><span class="s1">x.dtype != </span><span class="s3">&quot;O&quot; </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>
<span class="s0"># kategorik değişkenleri mode ile doldurma</span>
<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mode()[</span><span class="s4">0</span><span class="s1">]) </span><span class="s2">if </span><span class="s1">(x.dtype == </span><span class="s3">&quot;O&quot; </span><span class="s2">and </span><span class="s1">len(x.unique()) &lt;= </span><span class="s4">10</span><span class="s1">) </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>
<span class="s0"># kategorik değişken kırılımında sayısal değişkenleri doldurmak</span>
<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].transform(</span><span class="s3">&quot;mean&quot;</span><span class="s1">)).isnull().sum()</span>
<span class="s0"># Tahmine Dayalı Atama ile Doldurma</span>




<span class="s0">#############################################</span>
<span class="s0"># Gelişmiş Analizler</span>
<span class="s0">#############################################</span>

<span class="s0">###################</span>
<span class="s0"># Eksik Veri Yapısının İncelenmesi</span>
<span class="s0">###################</span>

<span class="s1">msno.bar(df)</span>
<span class="s1">plt.show()</span>

<span class="s1">msno.matrix(df)</span>
<span class="s1">plt.show()</span>

<span class="s1">msno.heatmap(df)</span>
<span class="s1">plt.show()</span>

<span class="s0">###################</span>
<span class="s0"># Eksik Değerlerin Bağımlı Değişken ile İlişkisinin İncelenmesi</span>
<span class="s0">###################</span>

<span class="s1">missing_values_table(df, </span><span class="s2">True</span><span class="s1">)</span>
<span class="s1">na_cols = missing_values_table(df, </span><span class="s2">True</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">missing_vs_target(dataframe, target, na_columns):</span>
    <span class="s1">temp_df = dataframe.copy()</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">na_columns:</span>
        <span class="s1">temp_df[col + </span><span class="s3">'_NA_FLAG'</span><span class="s1">] = np.where(temp_df[col].isnull(), </span><span class="s4">1</span><span class="s1">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">na_flags = temp_df.loc[:, temp_df.columns.str.contains(</span><span class="s3">&quot;_NA_&quot;</span><span class="s1">)].columns</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">na_flags:</span>
        <span class="s1">print(pd.DataFrame({</span><span class="s3">&quot;TARGET_MEAN&quot;</span><span class="s1">: temp_df.groupby(col)[target].mean(),</span>
                            <span class="s3">&quot;Count&quot;</span><span class="s1">: temp_df.groupby(col)[target].count()}), end=</span><span class="s3">&quot;</span><span class="s5">\n\n\n</span><span class="s3">&quot;</span><span class="s1">)</span>


<span class="s1">missing_vs_target(df, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">, na_cols)</span>



<span class="s0">###################</span>
<span class="s0"># Recap</span>
<span class="s0">###################</span>

<span class="s1">df = load()</span>
<span class="s1">na_cols = missing_values_table(df, </span><span class="s2">True</span><span class="s1">)</span>
<span class="s0"># sayısal değişkenleri direk median ile oldurma</span>
<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.median()) </span><span class="s2">if </span><span class="s1">x.dtype != </span><span class="s3">&quot;O&quot; </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>
<span class="s0"># kategorik değişkenleri mode ile doldurma</span>
<span class="s1">df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mode()[</span><span class="s4">0</span><span class="s1">]) </span><span class="s2">if </span><span class="s1">(x.dtype == </span><span class="s3">&quot;O&quot; </span><span class="s2">and </span><span class="s1">len(x.unique()) &lt;= </span><span class="s4">10</span><span class="s1">) </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">).isnull().sum()</span>
<span class="s0"># kategorik değişken kırılımında sayısal değişkenleri doldurmak</span>
<span class="s1">df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].fillna(df.groupby(</span><span class="s3">&quot;Sex&quot;</span><span class="s1">)[</span><span class="s3">&quot;Age&quot;</span><span class="s1">].transform(</span><span class="s3">&quot;mean&quot;</span><span class="s1">)).isnull().sum()</span>
<span class="s0"># Tahmine Dayalı Atama ile Doldurma</span>
<span class="s1">missing_vs_target(df, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">, na_cols)</span>





<span class="s0">#############################################</span>
<span class="s0"># 3. Encoding (Label Encoding, One-Hot Encoding, Rare Encoding)</span>
<span class="s0">#############################################</span>

<span class="s0">#############################################</span>
<span class="s0"># Label Encoding &amp; Binary Encoding</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>
<span class="s1">df.head()</span>
<span class="s1">df[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">].head()</span>

<span class="s1">le = LabelEncoder()</span>
<span class="s1">le.fit_transform(df[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">])[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span>
<span class="s1">le.inverse_transform([</span><span class="s4">0</span><span class="s1">, </span><span class="s4">1</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">label_encoder(dataframe, binary_col):</span>
    <span class="s1">labelencoder = LabelEncoder()</span>
    <span class="s1">dataframe[binary_col] = labelencoder.fit_transform(dataframe[binary_col])</span>
    <span class="s2">return </span><span class="s1">dataframe</span>

<span class="s1">df = load()</span>

<span class="s1">binary_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s1">df[col].dtype </span><span class="s2">not in </span><span class="s1">[int, float]</span>
               <span class="s2">and </span><span class="s1">df[col].nunique() == </span><span class="s4">2</span><span class="s1">]</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">binary_cols:</span>
    <span class="s1">label_encoder(df, col)</span>

<span class="s1">df.head()</span>

<span class="s1">df = load_application_train()</span>
<span class="s1">df.shape</span>

<span class="s1">binary_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s1">df[col].dtype </span><span class="s2">not in </span><span class="s1">[int, float]</span>
               <span class="s2">and </span><span class="s1">df[col].nunique() == </span><span class="s4">2</span><span class="s1">]</span>

<span class="s1">df[binary_cols].head()</span>


<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">binary_cols:</span>
    <span class="s1">label_encoder(df, col)</span>


<span class="s1">df = load()</span>
<span class="s1">df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].value_counts()</span>
<span class="s1">df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].nunique()</span>
<span class="s1">len(df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].unique())</span>

<span class="s0">#############################################</span>
<span class="s0"># One-Hot Encoding</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>
<span class="s1">df.head()</span>
<span class="s1">df[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">].value_counts()</span>

<span class="s1">pd.get_dummies(df, columns=[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">]).head()</span>

<span class="s1">pd.get_dummies(df, columns=[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">], drop_first=</span><span class="s2">True</span><span class="s1">).head()</span>

<span class="s1">pd.get_dummies(df, columns=[</span><span class="s3">&quot;Embarked&quot;</span><span class="s1">], dummy_na=</span><span class="s2">True</span><span class="s1">).head()</span>

<span class="s1">pd.get_dummies(df, columns=[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">, </span><span class="s3">&quot;Embarked&quot;</span><span class="s1">], drop_first=</span><span class="s2">True</span><span class="s1">).head()</span>

<span class="s2">def </span><span class="s1">one_hot_encoder(dataframe, categorical_cols, drop_first=</span><span class="s2">True</span><span class="s1">):</span>
    <span class="s1">dataframe = pd.get_dummies(dataframe, columns=categorical_cols, drop_first=drop_first)</span>
    <span class="s2">return </span><span class="s1">dataframe</span>

<span class="s1">df = load()</span>

<span class="s0"># cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s1">ohe_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s4">10 </span><span class="s1">&gt;= df[col].nunique() &gt; </span><span class="s4">2</span><span class="s1">]</span>


<span class="s1">one_hot_encoder(df, ohe_cols).head()</span>

<span class="s1">df.head()</span>

<span class="s0">#############################################</span>
<span class="s0"># Rare Encoding</span>
<span class="s0">#############################################</span>

<span class="s0"># 1. Kategorik değişkenlerin azlık çokluk durumunun analiz edilmesi.</span>
<span class="s0"># 2. Rare kategoriler ile bağımlı değişken arasındaki ilişkinin analiz edilmesi.</span>
<span class="s0"># 3. Rare encoder yazacağız.</span>

<span class="s0">###################</span>
<span class="s0"># 1. Kategorik değişkenlerin azlık çokluk durumunun analiz edilmesi.</span>
<span class="s0">###################</span>

<span class="s1">df = load_application_train()</span>
<span class="s1">df[</span><span class="s3">&quot;NAME_EDUCATION_TYPE&quot;</span><span class="s1">].value_counts()</span>

<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s2">def </span><span class="s1">cat_summary(dataframe, col_name, plot=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s1">print(pd.DataFrame({col_name: dataframe[col_name].value_counts(),</span>
                        <span class="s3">&quot;Ratio&quot;</span><span class="s1">: </span><span class="s4">100 </span><span class="s1">* dataframe[col_name].value_counts() / len(dataframe)}))</span>
    <span class="s1">print(</span><span class="s3">&quot;##########################################&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">plot:</span>
        <span class="s1">sns.countplot(x=dataframe[col_name], data=dataframe)</span>
        <span class="s1">plt.show()</span>


<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cat_cols:</span>
    <span class="s1">cat_summary(df, col)</span>

<span class="s0">###################</span>
<span class="s0"># 2. Rare kategoriler ile bağımlı değişken arasındaki ilişkinin analiz edilmesi.</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;NAME_INCOME_TYPE&quot;</span><span class="s1">].value_counts()</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;NAME_INCOME_TYPE&quot;</span><span class="s1">)[</span><span class="s3">&quot;TARGET&quot;</span><span class="s1">].mean()</span>


<span class="s2">def </span><span class="s1">rare_analyser(dataframe, target, cat_cols):</span>
    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cat_cols:</span>
        <span class="s1">print(col, </span><span class="s3">&quot;:&quot;</span><span class="s1">, len(dataframe[col].value_counts()))</span>
        <span class="s1">print(pd.DataFrame({</span><span class="s3">&quot;COUNT&quot;</span><span class="s1">: dataframe[col].value_counts(),</span>
                            <span class="s3">&quot;RATIO&quot;</span><span class="s1">: dataframe[col].value_counts() / len(dataframe),</span>
                            <span class="s3">&quot;TARGET_MEAN&quot;</span><span class="s1">: dataframe.groupby(col)[target].mean()}), end=</span><span class="s3">&quot;</span><span class="s5">\n\n\n</span><span class="s3">&quot;</span><span class="s1">)</span>

<span class="s1">rare_analyser(df, </span><span class="s3">&quot;TARGET&quot;</span><span class="s1">, cat_cols)</span>

<span class="s0">#############################################</span>
<span class="s0"># 3. Rare encoder'ın yazılması.</span>
<span class="s0">#############################################</span>

<span class="s2">def </span><span class="s1">rare_encoder(dataframe, rare_perc):</span>
    <span class="s1">temp_df = dataframe.copy()</span>

    <span class="s1">rare_columns = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">temp_df.columns </span><span class="s2">if </span><span class="s1">temp_df[col].dtypes == </span><span class="s3">'O'</span>
                    <span class="s2">and </span><span class="s1">(temp_df[col].value_counts() / len(temp_df) &lt; rare_perc).any(axis=</span><span class="s2">None</span><span class="s1">)]</span>

    <span class="s2">for </span><span class="s1">var </span><span class="s2">in </span><span class="s1">rare_columns:</span>
        <span class="s1">tmp = temp_df[var].value_counts() / len(temp_df)</span>
        <span class="s1">rare_labels = tmp[tmp &lt; rare_perc].index</span>
        <span class="s1">temp_df[var] = np.where(temp_df[var].isin(rare_labels), </span><span class="s3">'Rare'</span><span class="s1">, temp_df[var])</span>

    <span class="s2">return </span><span class="s1">temp_df</span>

<span class="s1">new_df = rare_encoder(df, </span><span class="s4">0.01</span><span class="s1">)</span>

<span class="s1">rare_analyser(new_df, </span><span class="s3">&quot;TARGET&quot;</span><span class="s1">, cat_cols)</span>

<span class="s1">df[</span><span class="s3">&quot;OCCUPATION_TYPE&quot;</span><span class="s1">].value_counts()</span>


<span class="s0">#############################################</span>
<span class="s0"># Feature Scaling (Özellik Ölçeklendirme)</span>
<span class="s0">#############################################</span>

<span class="s0">###################</span>
<span class="s0"># StandardScaler: Klasik standartlaştırma. Ortalamayı çıkar, standart sapmaya böl. z = (x - u) / s</span>
<span class="s0">###################</span>

<span class="s1">df = load()</span>
<span class="s1">ss = StandardScaler()</span>
<span class="s1">df[</span><span class="s3">&quot;Age_standard_scaler&quot;</span><span class="s1">] = ss.fit_transform(df[[</span><span class="s3">&quot;Age&quot;</span><span class="s1">]])</span>
<span class="s1">df.head()</span>


<span class="s0">###################</span>
<span class="s0"># RobustScaler: Medyanı çıkar iqr'a böl.</span>
<span class="s0">###################</span>

<span class="s1">rs = RobustScaler()</span>
<span class="s1">df[</span><span class="s3">&quot;Age_robuts_scaler&quot;</span><span class="s1">] = rs.fit_transform(df[[</span><span class="s3">&quot;Age&quot;</span><span class="s1">]])</span>
<span class="s1">df.describe().T</span>

<span class="s0">###################</span>
<span class="s0"># MinMaxScaler: Verilen 2 değer arasında değişken dönüşümü</span>
<span class="s0">###################</span>

<span class="s0"># X_std = (X - X.min(axis=0)) / (X.max(axis=0) - X.min(axis=0))</span>
<span class="s0"># X_scaled = X_std * (max - min) + min</span>

<span class="s1">mms = MinMaxScaler()</span>
<span class="s1">df[</span><span class="s3">&quot;Age_min_max_scaler&quot;</span><span class="s1">] = mms.fit_transform(df[[</span><span class="s3">&quot;Age&quot;</span><span class="s1">]])</span>
<span class="s1">df.describe().T</span>

<span class="s1">df.head()</span>

<span class="s1">age_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s3">&quot;Age&quot; </span><span class="s2">in </span><span class="s1">col]</span>

<span class="s2">def </span><span class="s1">num_summary(dataframe, numerical_col, plot=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s1">quantiles = [</span><span class="s4">0.05</span><span class="s1">, </span><span class="s4">0.10</span><span class="s1">, </span><span class="s4">0.20</span><span class="s1">, </span><span class="s4">0.30</span><span class="s1">, </span><span class="s4">0.40</span><span class="s1">, </span><span class="s4">0.50</span><span class="s1">, </span><span class="s4">0.60</span><span class="s1">, </span><span class="s4">0.70</span><span class="s1">, </span><span class="s4">0.80</span><span class="s1">, </span><span class="s4">0.90</span><span class="s1">, </span><span class="s4">0.95</span><span class="s1">, </span><span class="s4">0.99</span><span class="s1">]</span>
    <span class="s1">print(dataframe[numerical_col].describe(quantiles).T)</span>

    <span class="s2">if </span><span class="s1">plot:</span>
        <span class="s1">dataframe[numerical_col].hist(bins=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(numerical_col)</span>
        <span class="s1">plt.title(numerical_col)</span>
        <span class="s1">plt.show(block=</span><span class="s2">True</span><span class="s1">)</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">age_cols:</span>
    <span class="s1">num_summary(df, col, plot=</span><span class="s2">True</span><span class="s1">)</span>

<span class="s0">###################</span>
<span class="s0"># Numeric to Categorical: Sayısal Değişkenleri Kateorik Değişkenlere Çevirme</span>
<span class="s0"># Binning</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;Age_qcut&quot;</span><span class="s1">] = pd.qcut(df[</span><span class="s3">'Age'</span><span class="s1">], </span><span class="s4">5</span><span class="s1">)</span>

<span class="s0">#############################################</span>
<span class="s0"># Feature Extraction (Özellik Çıkarımı)</span>
<span class="s0">#############################################</span>

<span class="s0">#############################################</span>
<span class="s0"># Binary Features: Flag, Bool, True-False</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>
<span class="s1">df.head()</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Cabin&quot;</span><span class="s1">].notnull().astype(</span><span class="s3">'int'</span><span class="s1">)</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">).agg({</span><span class="s3">&quot;Survived&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">})</span>


<span class="s2">from </span><span class="s1">statsmodels.stats.proportion </span><span class="s2">import </span><span class="s1">proportions_ztest</span>

<span class="s1">test_stat, pvalue = proportions_ztest(count=[df.loc[df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] == </span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].sum(),</span>
                                             <span class="s1">df.loc[df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] == </span><span class="s4">0</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].sum()],</span>

                                      <span class="s1">nobs=[df.loc[df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] == </span><span class="s4">1</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].shape[</span><span class="s4">0</span><span class="s1">],</span>
                                            <span class="s1">df.loc[df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] == </span><span class="s4">0</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].shape[</span><span class="s4">0</span><span class="s1">]])</span>

<span class="s1">print(</span><span class="s3">'Test Stat = %.4f, p-value = %.4f' </span><span class="s1">% (test_stat, pvalue))</span>


<span class="s1">df.loc[((df[</span><span class="s3">'SibSp'</span><span class="s1">] + df[</span><span class="s3">'Parch'</span><span class="s1">]) &gt; </span><span class="s4">0</span><span class="s1">), </span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] = </span><span class="s3">&quot;NO&quot;</span>
<span class="s1">df.loc[((df[</span><span class="s3">'SibSp'</span><span class="s1">] + df[</span><span class="s3">'Parch'</span><span class="s1">]) == </span><span class="s4">0</span><span class="s1">), </span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] = </span><span class="s3">&quot;YES&quot;</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">).agg({</span><span class="s3">&quot;Survived&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">})</span>


<span class="s1">test_stat, pvalue = proportions_ztest(count=[df.loc[df[</span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] == </span><span class="s3">&quot;YES&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].sum(),</span>
                                             <span class="s1">df.loc[df[</span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] == </span><span class="s3">&quot;NO&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].sum()],</span>

                                      <span class="s1">nobs=[df.loc[df[</span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] == </span><span class="s3">&quot;YES&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].shape[</span><span class="s4">0</span><span class="s1">],</span>
                                            <span class="s1">df.loc[df[</span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] == </span><span class="s3">&quot;NO&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">].shape[</span><span class="s4">0</span><span class="s1">]])</span>

<span class="s1">print(</span><span class="s3">'Test Stat = %.4f, p-value = %.4f' </span><span class="s1">% (test_stat, pvalue))</span>

<span class="s0">#############################################</span>
<span class="s0"># Text'ler Üzerinden Özellik Türetmek</span>
<span class="s0">#############################################</span>

<span class="s1">df.head()</span>

<span class="s0">###################</span>
<span class="s0"># Letter Count</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_COUNT&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Name&quot;</span><span class="s1">].str.len()</span>

<span class="s0">###################</span>
<span class="s0"># Word Count</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_WORD_COUNT&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Name&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: len(str(x).split(</span><span class="s3">&quot; &quot;</span><span class="s1">)))</span>

<span class="s0">###################</span>
<span class="s0"># Özel Yapıları Yakalamak</span>
<span class="s0">###################</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_DR&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Name&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: len([x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">x.split() </span><span class="s2">if </span><span class="s1">x.startswith(</span><span class="s3">&quot;Dr&quot;</span><span class="s1">)]))</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;NEW_NAME_DR&quot;</span><span class="s1">).agg({</span><span class="s3">&quot;Survived&quot;</span><span class="s1">: [</span><span class="s3">&quot;mean&quot;</span><span class="s1">,</span><span class="s3">&quot;count&quot;</span><span class="s1">]})</span>

<span class="s0">###################</span>
<span class="s0"># Regex ile Değişken Türetmek</span>
<span class="s0">###################</span>

<span class="s1">df.head()</span>

<span class="s1">df[</span><span class="s3">'NEW_TITLE'</span><span class="s1">] = df.Name.str.extract(</span><span class="s3">' ([A-Za-z]+)\.'</span><span class="s1">, expand=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s1">df[[</span><span class="s3">&quot;NEW_TITLE&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">, </span><span class="s3">&quot;Age&quot;</span><span class="s1">]].groupby([</span><span class="s3">&quot;NEW_TITLE&quot;</span><span class="s1">]).agg({</span><span class="s3">&quot;Survived&quot;</span><span class="s1">: </span><span class="s3">&quot;mean&quot;</span><span class="s1">, </span><span class="s3">&quot;Age&quot;</span><span class="s1">: [</span><span class="s3">&quot;count&quot;</span><span class="s1">, </span><span class="s3">&quot;mean&quot;</span><span class="s1">]})</span>

<span class="s0">#############################################</span>
<span class="s0"># Date Değişkenleri Üretmek</span>
<span class="s0">#############################################</span>

<span class="s1">dff = pd.read_csv(</span><span class="s3">&quot;datasets/course_reviews.csv&quot;</span><span class="s1">)</span>
<span class="s1">dff.head()</span>
<span class="s1">dff.info()</span>

<span class="s1">dff[</span><span class="s3">'Timestamp'</span><span class="s1">] = pd.to_datetime(dff[</span><span class="s3">&quot;Timestamp&quot;</span><span class="s1">], format=</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>

<span class="s0"># year</span>
<span class="s1">dff[</span><span class="s3">'year'</span><span class="s1">] = dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.year</span>

<span class="s0"># month</span>
<span class="s1">dff[</span><span class="s3">'month'</span><span class="s1">] = dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.month</span>

<span class="s0"># year diff</span>
<span class="s1">dff[</span><span class="s3">'year_diff'</span><span class="s1">] = date.today().year - dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.year</span>

<span class="s0"># month diff (iki tarih arasındaki ay farkı): yıl farkı + ay farkı</span>
<span class="s1">dff[</span><span class="s3">'month_diff'</span><span class="s1">] = (date.today().year - dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.year) * </span><span class="s4">12 </span><span class="s1">+ date.today().month - dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.month</span>


<span class="s0"># day name</span>
<span class="s1">dff[</span><span class="s3">'day_name'</span><span class="s1">] = dff[</span><span class="s3">'Timestamp'</span><span class="s1">].dt.day_name()</span>

<span class="s1">dff.head()</span>

<span class="s0"># date</span>


<span class="s0">#############################################</span>
<span class="s0"># Feature Interactions (Özellik Etkileşimleri)</span>
<span class="s0">#############################################</span>
<span class="s1">df = load()</span>
<span class="s1">df.head()</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_AGE_PCLASS&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;Age&quot;</span><span class="s1">] * df[</span><span class="s3">&quot;Pclass&quot;</span><span class="s1">]</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_FAMILY_SIZE&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;SibSp&quot;</span><span class="s1">] + df[</span><span class="s3">&quot;Parch&quot;</span><span class="s1">] + </span><span class="s4">1</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngmale'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturemale'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniormale'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngfemale'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturefemale'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'SEX'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniorfemale'</span>


<span class="s1">df.head()</span>

<span class="s1">df.groupby(</span><span class="s3">&quot;NEW_SEX_CAT&quot;</span><span class="s1">)[</span><span class="s3">&quot;Survived&quot;</span><span class="s1">].mean()</span>


<span class="s0">#############################################</span>
<span class="s0"># Titanic Uçtan Uca Feature Engineering &amp; Data Preprocessing</span>
<span class="s0">#############################################</span>

<span class="s1">df = load()</span>
<span class="s1">df.shape</span>
<span class="s1">df.head()</span>

<span class="s1">df.columns = [col.upper() </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns]</span>

<span class="s0">#############################################</span>
<span class="s0"># 1. Feature Engineering (Değişken Mühendisliği)</span>
<span class="s0">#############################################</span>

<span class="s0"># Cabin bool</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_CABIN_BOOL&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;CABIN&quot;</span><span class="s1">].notnull().astype(</span><span class="s3">'int'</span><span class="s1">)</span>
<span class="s0"># Name count</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_COUNT&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;NAME&quot;</span><span class="s1">].str.len()</span>
<span class="s0"># name word count</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_WORD_COUNT&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;NAME&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: len(str(x).split(</span><span class="s3">&quot; &quot;</span><span class="s1">)))</span>
<span class="s0"># name dr</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_NAME_DR&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;NAME&quot;</span><span class="s1">].apply(</span><span class="s2">lambda </span><span class="s1">x: len([x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">x.split() </span><span class="s2">if </span><span class="s1">x.startswith(</span><span class="s3">&quot;Dr&quot;</span><span class="s1">)]))</span>
<span class="s0"># name title</span>
<span class="s1">df[</span><span class="s3">'NEW_TITLE'</span><span class="s1">] = df.NAME.str.extract(</span><span class="s3">' ([A-Za-z]+)\.'</span><span class="s1">, expand=</span><span class="s2">False</span><span class="s1">)</span>
<span class="s0"># family size</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_FAMILY_SIZE&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;SIBSP&quot;</span><span class="s1">] + df[</span><span class="s3">&quot;PARCH&quot;</span><span class="s1">] + </span><span class="s4">1</span>
<span class="s0"># age_pclass</span>
<span class="s1">df[</span><span class="s3">&quot;NEW_AGE_PCLASS&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;AGE&quot;</span><span class="s1">] * df[</span><span class="s3">&quot;PCLASS&quot;</span><span class="s1">]</span>
<span class="s0"># is alone</span>
<span class="s1">df.loc[((df[</span><span class="s3">'SIBSP'</span><span class="s1">] + df[</span><span class="s3">'PARCH'</span><span class="s1">]) &gt; </span><span class="s4">0</span><span class="s1">), </span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] = </span><span class="s3">&quot;NO&quot;</span>
<span class="s1">df.loc[((df[</span><span class="s3">'SIBSP'</span><span class="s1">] + df[</span><span class="s3">'PARCH'</span><span class="s1">]) == </span><span class="s4">0</span><span class="s1">), </span><span class="s3">&quot;NEW_IS_ALONE&quot;</span><span class="s1">] = </span><span class="s3">&quot;YES&quot;</span>
<span class="s0"># age level</span>
<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &lt; </span><span class="s4">18</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'young'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &gt;= </span><span class="s4">18</span><span class="s1">) &amp; (df[</span><span class="s3">'AGE'</span><span class="s1">] &lt; </span><span class="s4">56</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'mature'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &gt;= </span><span class="s4">56</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'senior'</span>
<span class="s0"># sex x age</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngmale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniormale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngfemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturefemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniorfemale'</span>

<span class="s1">df.head()</span>
<span class="s1">df.shape</span>

<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s3">&quot;PASSENGERID&quot; </span><span class="s2">not in </span><span class="s1">col]</span>

<span class="s0">#############################################</span>
<span class="s0"># 2. Outliers (Aykırı Değerler)</span>
<span class="s0">#############################################</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">replace_with_thresholds(df, col)</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols:</span>
    <span class="s1">print(col, check_outlier(df, col))</span>

<span class="s0">#############################################</span>
<span class="s0"># 3. Missing Values (Eksik Değerler)</span>
<span class="s0">#############################################</span>

<span class="s1">missing_values_table(df)</span>

<span class="s1">df.drop(</span><span class="s3">&quot;CABIN&quot;</span><span class="s1">, inplace=</span><span class="s2">True</span><span class="s1">, axis=</span><span class="s4">1</span><span class="s1">)</span>

<span class="s1">remove_cols = [</span><span class="s3">&quot;TICKET&quot;</span><span class="s1">, </span><span class="s3">&quot;NAME&quot;</span><span class="s1">]</span>
<span class="s1">df.drop(remove_cols, inplace=</span><span class="s2">True</span><span class="s1">, axis=</span><span class="s4">1</span><span class="s1">)</span>


<span class="s1">df[</span><span class="s3">&quot;AGE&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;AGE&quot;</span><span class="s1">].fillna(df.groupby(</span><span class="s3">&quot;NEW_TITLE&quot;</span><span class="s1">)[</span><span class="s3">&quot;AGE&quot;</span><span class="s1">].transform(</span><span class="s3">&quot;median&quot;</span><span class="s1">))</span>


<span class="s1">df[</span><span class="s3">&quot;NEW_AGE_PCLASS&quot;</span><span class="s1">] = df[</span><span class="s3">&quot;AGE&quot;</span><span class="s1">] * df[</span><span class="s3">&quot;PCLASS&quot;</span><span class="s1">]</span>

<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &lt; </span><span class="s4">18</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'young'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &gt;= </span><span class="s4">18</span><span class="s1">) &amp; (df[</span><span class="s3">'AGE'</span><span class="s1">] &lt; </span><span class="s4">56</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'mature'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'AGE'</span><span class="s1">] &gt;= </span><span class="s4">56</span><span class="s1">), </span><span class="s3">'NEW_AGE_CAT'</span><span class="s1">] = </span><span class="s3">'senior'</span>

<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngmale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'male'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniormale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt;= </span><span class="s4">21</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'youngfemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt; </span><span class="s4">21</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &lt; </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'maturefemale'</span>
<span class="s1">df.loc[(df[</span><span class="s3">'Sex'</span><span class="s1">] == </span><span class="s3">'female'</span><span class="s1">) &amp; (df[</span><span class="s3">'Age'</span><span class="s1">] &gt;= </span><span class="s4">50</span><span class="s1">), </span><span class="s3">'NEW_SEX_CAT'</span><span class="s1">] = </span><span class="s3">'seniorfemale'</span>


<span class="s1">df = df.apply(</span><span class="s2">lambda </span><span class="s1">x: x.fillna(x.mode()[</span><span class="s4">0</span><span class="s1">]) </span><span class="s2">if </span><span class="s1">(x.dtype == </span><span class="s3">&quot;O&quot; </span><span class="s2">and </span><span class="s1">len(x.unique()) &lt;= </span><span class="s4">10</span><span class="s1">) </span><span class="s2">else </span><span class="s1">x, axis=</span><span class="s4">0</span><span class="s1">)</span>

<span class="s0">#############################################</span>
<span class="s0"># 4. Label Encoding</span>
<span class="s0">#############################################</span>

<span class="s1">binary_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s1">df[col].dtype </span><span class="s2">not in </span><span class="s1">[int, float]</span>
               <span class="s2">and </span><span class="s1">df[col].nunique() == </span><span class="s4">2</span><span class="s1">]</span>

<span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">binary_cols:</span>
    <span class="s1">df = label_encoder(df, col)</span>


<span class="s0">#############################################</span>
<span class="s0"># 5. Rare Encoding</span>
<span class="s0">#############################################</span>

<span class="s1">rare_analyser(df, </span><span class="s3">&quot;SURVIVED&quot;</span><span class="s1">, cat_cols)</span>


<span class="s1">df = rare_encoder(df, </span><span class="s4">0.01</span><span class="s1">)</span>

<span class="s1">df[</span><span class="s3">&quot;NEW_TITLE&quot;</span><span class="s1">].value_counts()</span>

<span class="s0">#############################################</span>
<span class="s0"># 6. One-Hot Encoding</span>
<span class="s0">#############################################</span>

<span class="s1">ohe_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s4">10 </span><span class="s1">&gt;= df[col].nunique() &gt; </span><span class="s4">2</span><span class="s1">]</span>

<span class="s1">df = one_hot_encoder(df, ohe_cols)</span>

<span class="s1">df.head()</span>
<span class="s1">df.shape</span>


<span class="s1">cat_cols, num_cols, cat_but_car = grab_col_names(df)</span>

<span class="s1">num_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">num_cols </span><span class="s2">if </span><span class="s3">&quot;PASSENGERID&quot; </span><span class="s2">not in </span><span class="s1">col]</span>

<span class="s1">rare_analyser(df, </span><span class="s3">&quot;SURVIVED&quot;</span><span class="s1">, cat_cols)</span>

<span class="s1">useless_cols = [col </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">df.columns </span><span class="s2">if </span><span class="s1">df[col].nunique() == </span><span class="s4">2 </span><span class="s2">and</span>
                <span class="s1">(df[col].value_counts() / len(df) &lt; </span><span class="s4">0.01</span><span class="s1">).any(axis=</span><span class="s2">None</span><span class="s1">)]</span>

<span class="s0"># df.drop(useless_cols, axis=1, inplace=True)</span>

<span class="s0">#############################################</span>
<span class="s0"># 7. Standart Scaler</span>
<span class="s0">#############################################</span>

<span class="s1">scaler = StandardScaler()</span>
<span class="s1">df[num_cols] = scaler.fit_transform(df[num_cols])</span>

<span class="s1">df[num_cols].head()</span>

<span class="s1">df.head()</span>
<span class="s1">df.shape</span>


<span class="s0">#############################################</span>
<span class="s0"># 8. Model</span>
<span class="s0">#############################################</span>

<span class="s1">y = df[</span><span class="s3">&quot;SURVIVED&quot;</span><span class="s1">]</span>
<span class="s1">X = df.drop([</span><span class="s3">&quot;PASSENGERID&quot;</span><span class="s1">, </span><span class="s3">&quot;SURVIVED&quot;</span><span class="s1">], axis=</span><span class="s4">1</span><span class="s1">)</span>

<span class="s1">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=</span><span class="s4">0.30</span><span class="s1">, random_state=</span><span class="s4">17</span><span class="s1">)</span>

<span class="s2">from </span><span class="s1">sklearn.ensemble </span><span class="s2">import </span><span class="s1">RandomForestClassifier</span>

<span class="s1">rf_model = RandomForestClassifier(random_state=</span><span class="s4">46</span><span class="s1">).fit(X_train, y_train)</span>
<span class="s1">y_pred = rf_model.predict(X_test)</span>
<span class="s1">accuracy_score(y_pred, y_test)</span>

<span class="s0">#############################################</span>
<span class="s0"># Hiç bir işlem yapılmadan elde edilecek skor?</span>
<span class="s0">#############################################</span>

<span class="s1">dff = load()</span>
<span class="s1">dff.dropna(inplace=</span><span class="s2">True</span><span class="s1">)</span>
<span class="s1">dff = pd.get_dummies(dff, columns=[</span><span class="s3">&quot;Sex&quot;</span><span class="s1">, </span><span class="s3">&quot;Embarked&quot;</span><span class="s1">], drop_first=</span><span class="s2">True</span><span class="s1">)</span>
<span class="s1">y = dff[</span><span class="s3">&quot;Survived&quot;</span><span class="s1">]</span>
<span class="s1">X = dff.drop([</span><span class="s3">&quot;PassengerId&quot;</span><span class="s1">, </span><span class="s3">&quot;Survived&quot;</span><span class="s1">, </span><span class="s3">&quot;Name&quot;</span><span class="s1">, </span><span class="s3">&quot;Ticket&quot;</span><span class="s1">, </span><span class="s3">&quot;Cabin&quot;</span><span class="s1">], axis=</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=</span><span class="s4">0.30</span><span class="s1">, random_state=</span><span class="s4">17</span><span class="s1">)</span>
<span class="s1">rf_model = RandomForestClassifier(random_state=</span><span class="s4">46</span><span class="s1">).fit(X_train, y_train)</span>
<span class="s1">y_pred = rf_model.predict(X_test)</span>
<span class="s1">accuracy_score(y_pred, y_test)</span>

<span class="s0"># Yeni ürettiğimiz değişkenler ne alemde?</span>

<span class="s2">def </span><span class="s1">plot_importance(model, features, num=len(X), save=</span><span class="s2">False</span><span class="s1">):</span>
    <span class="s1">feature_imp = pd.DataFrame({</span><span class="s3">'Value'</span><span class="s1">: model.feature_importances_, </span><span class="s3">'Feature'</span><span class="s1">: features.columns})</span>
    <span class="s1">plt.figure(figsize=(</span><span class="s4">10</span><span class="s1">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">sns.set(font_scale=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">sns.barplot(x=</span><span class="s3">&quot;Value&quot;</span><span class="s1">, y=</span><span class="s3">&quot;Feature&quot;</span><span class="s1">, data=feature_imp.sort_values(by=</span><span class="s3">&quot;Value&quot;</span><span class="s1">,</span>
                                                                      <span class="s1">ascending=</span><span class="s2">False</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">:num])</span>
    <span class="s1">plt.title(</span><span class="s3">'Features'</span><span class="s1">)</span>
    <span class="s1">plt.tight_layout()</span>
    <span class="s1">plt.show()</span>
    <span class="s2">if </span><span class="s1">save:</span>
        <span class="s1">plt.savefig(</span><span class="s3">'importances.png'</span><span class="s1">)</span>


<span class="s1">plot_importance(rf_model, X_train)</span>


</pre>
</body>
</html>